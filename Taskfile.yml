# https://taskfile.dev

version: '3'

vars:
  NAME: blog

tasks:
  default:
    desc: Show available tasks
    silent: true
    cmds:
      - task --list

  # Development tasks
  dev:
    desc: Start Hugo development server with live reload (in Docker)
    dir: site
    cmds:
      - echo "ğŸ³ Building dev container..."
      - docker build --target dev -t blog-dev .
      - echo "ğŸš€ Starting Hugo development server..."
      - echo "   Available at http://localhost:1313"
      - echo "   Press Ctrl+C to stop"
      - docker run --rm -it -p 1313:1313 -v "{{.TASKFILE_DIR}}/site:/project" blog-dev
    silent: true

  # Build tasks
  build:
    desc: Build the Hugo site using Dagger
    cmds:
      - echo "ğŸ› ï¸ Building Hugo site..."
      - dagger call hugo-build --source . export --path ./public
    silent: true

  lint:
    desc: Run golangci-lint on Go code
    cmds:
      - echo "ğŸ” Running linter..."
      - dagger call lint --source .
    silent: true

  test:
    desc: Run Go tests
    cmds:
      - echo "ğŸ§ª Running tests..."
      - dagger call test --source .
    silent: true

  # Container tasks
  container:
    desc: Build the container image using Dagger
    cmds:
      - echo "ğŸ³ Building container image..."
      - dagger call container --source . --git .git
    silent: true

  container-run:
    desc: Build and run the container locally for testing
    cmds:
      - echo "ğŸ³ Building and running container..."
      - dagger call container --source . --git .git as-tarball export --path ./blog.tar
      - |
        IMAGE_ID=$(docker load -i blog.tar | sed -n 's/.*\(sha256:[a-f0-9]*\).*/\1/p')
        docker tag $IMAGE_ID blog:latest
      - rm blog.tar
      - echo "ğŸš€ Starting container on port 8080..."
      - echo "   Metrics available at http://localhost:9101/metrics"
      - echo "   Press Ctrl+C to stop"
      - docker run --rm -p 8080:8080 -p 9101:9101 blog:latest
    silent: true

  # Clean tasks
  clean:
    desc: Clean all generated files
    cmds:
      - echo "ğŸ§¹ Cleaning up..."
      - rm -rf public
      - rm -rf site/public
      - rm -rf site/resources
      - rm -rf site/node_modules
      - rm -f site/hugo_stats.json
      - rm -f site/package.json
      - rm -f site/package-lock.json
      - rm -f blog
      - echo "âœ… Cleanup complete"
    silent: true
    ignore_error: true
